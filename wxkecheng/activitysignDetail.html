<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title></title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <link rel="shortcut icon" href="images/favicon.png" type="image/png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <link rel="stylesheet" href="css/sm.min.css">
    <link rel="stylesheet" href="css/sm-extend.min.css">
    <link rel="stylesheet" href="css/dropload.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
    	.content{background: #fff;}
    </style>
  </head>
  <body>
    <div class="page-group">
			<div class="page">
			  <nav class="bar bar-tab" style="position: fixed; bottom: 0; left: 0;" id="activityStatus">
			    
			  </nav>
			  <div class="content">
			  	<img class="bannerdetail" src="" id="activityPicUrl" alt="" />
			  	<div class="content-padded position">
			  		<div class="btactiv"><h3 id="activityName"></h3></div>
			  		<div class="xxsd">
			  			<p><img src="images/time.png" alt="" /> <span id="activityTime"></span></p>
			  			<p><img src="images/add.png" alt="" /> <span id="activityAddress"></span></p>
			  			<p><img src="images/my.png" alt="" /> <span>已报名<font id="signUpCount"></font>人</span></p>
			  			<p><img src="images/lll.png" alt="" /> <span>已有<font id="remark"></font>人浏览</span></p>
			  			<p><img src="images/mol.png" alt="" /> <span id="price"></span></p>
			  		</div>
			  	</div>
			  	<div class="huibian">
			  		<div class="content-padded position">
			  			<div class="detailxx" id="activityContent">
			  				
			  			</div>
			  		</div>
			  	</div>
			  	<div class="huibian">
			  		<div class="content-padded position">
			  			<div class="detailbt">
			  				<span id="signmore"><a href="javascript:;" class="open-sign">更多报名 ></a></span>已报名(<font class="total"></font>)
			  			</div>
			  			<ul class="dsdlist" id="dsdlist">
			  				
			  			</ul>
			  		</div>
			  	</div>
			  	<div class="huibian displayno" id="evaluatedsed">
			  		<div class="content-padded position">
			  			<div class="detailbt">
			  				<span id="evaluatemore"><a href="javascript:;" class="open-evaluate">更多评价 ></a></span>评价详情
			  			</div>
			  			<div class="evaluatelist" id="evaluatelist">
			  				

			  			</div>
			  		</div>
			  	</div>
			  	<div class="huibian displayno" id="evaluateActivit">
			  		<div class="content-padded position">
			  			<div class="detailbt">
			  				评价活动
			  			</div>
		  			</div>
				    <div class="list-block">
					    <ul>
					      <!-- Text inputs -->
					      <li>
					        <div class="item-content">
					          <div class="item-media"><i class="icon icon-form-name"></i></div>
					          <div class="item-inner">
					            <div class="item-title label"><span class="hong">*</span> 评分：</div>
					            <div class="item-input">
					              <div class="plxx"><span class="no-xx oncikxx1"></span><span class="no-xx oncikxx2"></span><span class="no-xx oncikxx3"></span><span class="no-xx oncikxx4"></span><span class="no-xx oncikxx5"></span></div>
					            </div>
					          </div>
					        </div>
					      </li>
					      <li class="align-top">
					        <div class="item-content">
					          <div class="item-media"><i class="icon icon-form-comment"></i></div>
					          <div class="item-inner">
					            <div class="item-title label"><span class="hong">*</span> 评价文字：</div>
					            <div class="item-input">
					              <textarea id="evaluat" placeholder="请输入描述"></textarea>
					            </div>
					          </div>
					        </div>
					      </li>
					    </ul>
					  </div>
					  <div class="button-block">
					    <div class="row">
					    	<div class="col-50"><a href="javascript:;" id="Submission" class="button button-big button-fill button-success">提交</a></div>
					      <div class="col-50"><a href="javascript:;" class="button button-big button-fill button-hui close-popup">取消</a></div>
					    </div>
					  </div>
			  		<div style="height: .8rem;"></div>
			  	</div>
			  </div>
			</div>
    </div>
    
    <!-- sign Popup -->
		<div class="popup popup-sign">
		  <div class="content-block-all">
		  	<a href="javascript:;" class="close-popup close-x">x</a>
		    <h3 class="tcbt">已报名(<span class="total"></span>)</h3>
		    <ul class="dsdlist" id="dsdlist2">
					
  			</ul>
			  
				  
		  </div>
		</div>
		
		<!-- sign evaluate -->
		<div class="popup popup-evaluate">
		  <div class="content-block-all">
		  	<a href="javascript:;" class="close-popup close-x">x</a>
		    <h3 class="tcbt">评价详情(<span class="total"></span>)</h3>
		    
			  <div class="evaluatelist" id="evaluatelistmore">
	  				
	  		</div>
				  
		  </div>
		</div>

    <script type='text/javascript' src='js/zepto.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='js/sm.min.js' charset='utf-8'></script>
    <script type='text/javascript' src='js/sm-extend.min.js' charset='utf-8'></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
    <script src="js/json2.js"></script>
    <script src="js/dropload.min.js"></script>
    <script type='text/javascript' src='js/visitip.js' charset='utf-8'></script>
	<script>
		var activityOpenid = JSON.parse(localStorage.getItem('activityOpenid'));
		var activityNickName = JSON.parse(localStorage.getItem('activityNickName'));
		var activityHeadimgurl = JSON.parse(localStorage.getItem('activityHeadimgurl'));
		var testurl = window.location.href;
		var param = getRequest();
		var activityCode = param["activityCode"];
		var grade;
		$(document).on('click','.open-sign', function () {
		  $.popup('.popup-sign');
		});
		$(document).on('click','.open-evaluate', function () {
		  $.popup('.popup-evaluate');
		});
		$(document).ready(function() {
			getActivityDetail();
			getSignUpInfos();
			getSignUpInfosmore();
			getWxConfig();
			$("#Submission").bind("click", evaluateCourse);
			
			$(".plxx").on('click','.oncikxx1',function(){
				$(this).removeClass('no-xx');
				$(this).siblings(".oncikxx2").addClass('no-xx');
				$(this).siblings(".oncikxx3").addClass('no-xx');
				$(this).siblings(".oncikxx4").addClass('no-xx');
				$(this).siblings(".oncikxx5").addClass('no-xx');
				grade = '1';
			})
			$(".plxx").on('click','.oncikxx2',function(){
				$(this).removeClass('no-xx');
				$(this).siblings(".oncikxx1").removeClass('no-xx');
				$(this).siblings(".oncikxx3").addClass('no-xx');
				$(this).siblings(".oncikxx4").addClass('no-xx');
				$(this).siblings(".oncikxx5").addClass('no-xx');
				grade = '2';
			})
			$(".plxx").on('click','.oncikxx3',function(){
				$(this).removeClass('no-xx');
				$(this).siblings(".oncikxx1").removeClass('no-xx');
				$(this).siblings(".oncikxx2").removeClass('no-xx');
				$(this).siblings(".oncikxx4").addClass('no-xx');
				$(this).siblings(".oncikxx5").addClass('no-xx');
				grade = '3';
			})
			$(".plxx").on('click','.oncikxx4',function(){
				$(this).removeClass('no-xx');
				$(this).siblings(".oncikxx1").removeClass('no-xx');
				$(this).siblings(".oncikxx2").removeClass('no-xx');
				$(this).siblings(".oncikxx3").removeClass('no-xx');
				$(this).siblings(".oncikxx5").addClass('no-xx');
				grade = '4';
			})
			$(".plxx").on('click','.oncikxx5',function(){
				$(this).removeClass('no-xx');
				$(this).siblings(".oncikxx1").removeClass('no-xx');
				$(this).siblings(".oncikxx2").removeClass('no-xx');
				$(this).siblings(".oncikxx3").removeClass('no-xx');
				$(this).siblings(".oncikxx4").removeClass('no-xx');
				grade = '5';
			})
			
			
		});
		function getNow(s) {
		    return s < 10 ? '0' + s: s;
		}
		
		var myDate = new Date();
		//获取当前年
		var year=myDate.getFullYear();
		//获取当前月
		var month=myDate.getMonth()+1;
		//获取当前日
		var date=myDate.getDate(); 
		var h=myDate.getHours();       //获取当前小时数(0-23)
		var m=myDate.getMinutes();     //获取当前分钟数(0-59)
		var s=myDate.getSeconds();  
		
		var now=year+'-'+getNow(month)+"-"+getNow(date)+" "+getNow(h)+':'+getNow(m)+":"+getNow(s);
		function getActivityDetail() {
			$.ajax({
					type: "POST",
					url: ulrTo + "/azz/api/client/activity/getActivityDetail",
					cache: false, //禁用缓存   
					dataType: "json", 
					async: false,
					data: {
						'activityCode': activityCode,
						'openid': activityOpenid
					},
					success: function(data) {
						if (data.code == 0) {
							var data = data.data;
							$('#activityPicUrl').attr('src',data.activityPicUrl);
							$('title').html(data.activityName + '-爱智造产业学院');
							$('#activityName').html(data.activityName);
							$('#activityContent').html(data.activityContent);
							$('#activityTime').html(data.activityTime);
							$('#activityAddress').html(data.activityAddress);
							$('#signUpCount').html(data.signUpCount);
							if(!data.remark){
								$('#remark').html('0');
							}else{
								$('#remark').html(data.remark);
							}
							if(data.price==0){
								$('#price').html('免费');
							}else{
								$('#price').html(data.price+'元');
							}
							$('.total').html(data.signUpCount);
							if(data.activityStatus == 1){
								$('#activityStatus').html("<a class='baoming2 external' onclick=\"activityfrom(\'" + data.activityCode + "\');\" href='javascript:;'>立即报名</a>");
							}else{
								$('#activityStatus').html("<p align='center' style='color: #999; line-height: 1rem;'>已结束</p>");
							}
							if(data.isSignUp == 1){
								$('#activityStatus').html("<p align='center' style='color: #999; line-height: 1rem;'>已报名</p>");
							}
							if(now > data.activityTime){
								getEvaluationInfos();
								getEvaluationInfosmore();
								$('#evaluatedsed').show();
								if(data.isSignUp == 1){
									if(data.isEvaluated == 0){
										$('#evaluateActivit').show();
									}
								}
							}
							
							
						} else {
							$.toast(data.msg)
						}
					}
			});
		}
		function activityfrom(activityCode){
			if(!window.localStorage){
	        return false;
	    }else{
	    var storage=window.localStorage;
	    var activityCode = JSON.stringify(activityCode);
	    storage["activityCode"]= activityCode;
	    }
	    window.location.href = "activityfromto.html";/*https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx6657c21ece08b798&redirect_uri=http%3a%2f%2fa.izz2025.com/activityfrom.html&response_type=code&scope=snsapi_userinfo#wechat_redirect*/
			return;
		}
		function getSignUpInfos() {
			$.ajax({
					type: "POST",
					url: ulrTo + "/azz/api/client/activity/getSignUpInfos",
					cache: false, //禁用缓存   
					async: false,
					dataType: "json", 
					data: {
						'activityCode': activityCode,
						'pageNum' : '1',
						'pageSize' : '5',
					},
					success: function(data) {
						if (data.code == 0) {
							/*$('.total').html(data.data.total);*/
							var rows = data.data.rows;
							if(!rows || !rows.length){
								$('#signmore').hide();
								$("#dsdlist").html('<li style="width: 100%; color: #999;">还没有人报名哦，赶紧报名吧！</li>');
							}else{
								var li = '';
								for(var i = 0;i<rows.length;i++){
									var nickname = rows[i].nickname;
									var headImageUrl = rows[i].headImageUrl;
									li +="<li><div class='tu'><img src='"+ headImageUrl +"' alt='' /></div><p>"+ nickname +"</p></li>";
							  }
								$("#dsdlist").append(li);
							}
						} else {
							$.toast(data.msg)
						}
					}
			});
		}
		function getSignUpInfosmore() {
			$.ajax({
					type: "POST",
					url: ulrTo + "/azz/api/client/activity/getSignUpInfos",
					cache: false, //禁用缓存   
					async: false,
					dataType: "json", 
					data: {
						'activityCode': activityCode,
						'pageNum' : '1',
						'pageSize' : '99999',
					},
					success: function(data) {
						if (data.code == 0) {
							var rows = data.data.rows;
							var li = '';
							if(rows.length < 6){
								$('#signmore').hide();
							}
							for(var i = 0;i<rows.length;i++){
								var nickname = rows[i].nickname;
								var headImageUrl = rows[i].headImageUrl;
								li +="<li><div class='tu'><img src='"+ headImageUrl +"' alt='' /></div><p>"+ nickname +"</p></li>";
						  }
							$("#dsdlist2").append(li);
							
						} else {
							$.toast(data.msg)
						}
					}
			});
		}
		
		function getWxConfig() {
	    $.ajax({
	        type: "POST",
	        cache: false, //禁用缓存 
	        async: false,
	        url: ulrTo + "/azz/api/client/activity/getWxConfig",
	        data: {
	            url: testurl
	        },
	        success(data) {
	        	if (data.code == 0) {
	            wx.config({
				        debug:false, //调式模式，设置为ture后会直接在网页上弹出调试信息，用于排查问题
				        appId: data.data.appid,
				        timestamp:data.data.timestamp,
				        nonceStr: data.data.nonceStr,
				        signature:  data.data.signature,
				        jsApiList: [ //需要使用的网页服务接口
				            'checkJsApi', //判断当前客户端版本是否支持指定JS接口
				            'onMenuShareTimeline', //分享到朋友圈
				            'onMenuShareAppMessage', //分享给好友
				            'onMenuShareQQ', //分享到QQ
				        ]
					    });
					    wx.ready(function () {
					    	wx.onMenuShareTimeline({ //例如分享到朋友圈的API 
					        title: $('#activityName').html(), // 分享标题
					        link: testurl, // 分享链接
					        imgUrl: 'http://a.izz2025.com/images/shoollogo.png', // 分享图标
					        success: function () {
					            // 用户确认分享后执行的回调函数
					            $.toast('已分享');
					        },
					        cancel: function () {
					            // 用户取消分享后执行的回调函数
					 						$.toast('已取消');
					        }
						    });
						    wx.onMenuShareAppMessage({
						        title:$('#activityName').html(), // 分享标题
						        desc: '还等什么，赶紧报名吧！提升自己从现在开始。', // 分享描述
						        link: testurl, // 分享链接
						        imgUrl: 'http://a.izz2025.com/images/shoollogo.png', // 分享图标
						        type: '', // 分享类型,music、video或link，不填默认为link
						        dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
						        success: function () {
						            // 用户确认分享后执行的回调函数
						            $.toast('已分享');
						        },
						        cancel: function () {
						            // 用户取消分享后执行的回调函数
						            $.toast('已取消');
						        }
						   	});
						    wx.onMenuShareQQ({
					        title: $('#activityName').html(), // 分享标题
					        desc: '还等什么，赶紧报名吧！提升自己从现在开始。', // 分享描述
					        link: testurl, // 分享链接
					        imgUrl: 'http://a.izz2025.com/images/shoollogo.png', // 分享图标
					        success: function () {
					            // 用户确认分享后执行的回调函数
					 						$.toast('已分享');
					        },
					        cancel: function () {
					            // 用户取消分享后执行的回调函数
					            $.toast('已取消');
					        }
								});    	
							});
							
							wx.error(function (res) {
							    $.toast(res.errMsg); 
							//打印错误消息。及把 debug:false,设置为debug:ture就可以直接在网页上看到弹出的错误提示
							});
				    } else {
							$.toast(data.msg)
						}
	        }
			});
		}
		
		//评价
		function evaluateCourse() {
			if(!grade){
				$.toast('请先评分！');
				return;
			}
			if(!$("#evaluat").val()){
				$.toast('请输入评价内容');
				return;
			}
			$.ajax({
					type: "POST",
					url: ulrTo + "/azz/api/client/activity/evaluateActivity",
					cache: false, //禁用缓存   
					dataType: "json", 
					data: {
						'activityCode': activityCode,
						'openid': activityOpenid,
						'nickname': activityNickName,
						'headImageUrl': activityHeadimgurl,
						'grade': grade,
						'evaluationContent': $("#evaluat").val(),
					},
					success: function(data) {
						if (data.code == 0) {
		  					$.toast("评价成功！即将返回列表页");
		  					setInterval(function(){
								    window.location.href = "activitySign.html"
								},2000);
						} else {
							$.toast(data.msg);
						}
					}
			});
		}
		
		//评价详情
		function getEvaluationInfos() {
			$.ajax({
					type: "POST",
					url: ulrTo + "/azz/api/client/activity/getEvaluationInfos",
					cache: false, //禁用缓存   
					async: false,
					dataType: "json", 
					data: {
						'activityCode': activityCode,
						'pageNum' : '1',
						'pageSize' : '5',
					},
					success: function(data) {
						if (data.code == 0) {
							var rows = data.data.rows;
							if(!rows || !rows.length){
								$("#evaluatelist").html('<div style="width: 100%; color: #999; font-size: .6rem; text-align: center;">还没有人评价哦！</div>');
							}else{
								var li = '';
								for(var i = 0;i<rows.length;i++){
									var nickName = rows[i].nickname;
                	var avatarUrl = rows[i].headImageUrl;
                	var createTime = rows[i].createTime;
                	var evaluationContent = rows[i].evaluationContent;
                	if(rows[i].grade==1){
                		var grade ="<span></span><span class='no-xx'></span><span class='no-xx'></span><span class='no-xx'></span><span class='no-xx'></span>"
                	}else if(rows[i].grade==2){
                		var grade ="<span></span><span></span><span class='no-xx'></span><span class='no-xx'></span><span class='no-xx'></span>"
                	}else if(rows[i].grade==3){
                		var grade ="<span></span><span></span><span></span><span class='no-xx'></span><span class='no-xx'></span>"
                	}else if(rows[i].grade==4){
                		var grade ="<span></span><span></span><span></span><span></span><span class='no-xx'></span>"
                	}else if(rows[i].grade==5){
                		var grade ="<span></span><span></span><span></span><span></span><span></span>"
                	}
									li +="<div class='plList'><div class='left tu'><div class='pltu'><img src='"+ avatarUrl +"' alt='' /></div>"+ nickName +"</div><div class='right plzi'>"
	                   + "<div class='plxx'>"+grade
	                   + "<div class='timed'>"+ createTime +"</div></div><div class='pltail'>"+ evaluationContent +"</div></div></div>";
							  }
								$("#evaluatelist").append(li);
							}
						} else {
							$.toast(data.msg)
						}
					}
			});
		}
		
		function getEvaluationInfosmore() {
				  // 页数
		      var page = 0;
		      // 每页展示5个
		      var size = 5;
		 
		     // dropload
		    $('#tab3').dropload({
		      scrollArea : window,
		      threshold : 100,//提前加载距离
		      
			    loadDownFn : function(me){
		        page++;
		        // 拼接HTML
		        var result = '';
		        $.ajax({
		          type: 'POST',
		          url: ulrTo + '/azz/api/client/activity/getEvaluationInfos',
		          dataType: 'json',
		          data: {
		          	'activityCode': activityCode,
								'pageNum' : page,
								'pageSize' : '5',
							},
		          success: function(data){
		          	if (data.code == 0) {
		              var rows = data.data.rows;
		              var arrLen = rows.length;
		              if(arrLen < 6){
										$('#evaluatemore').hide();
									}
			              if(arrLen > 0){
			                for(var i=0; i<arrLen; i++){
			                	var nickName = rows[i].nickname;
			                	var avatarUrl = rows[i].headImageUrl;
			                	var createTime = rows[i].createTime;
			                	var evaluationContent = rows[i].evaluationContent;
			                	if(rows[i].grade==1){
			                		var grade ="<span></span><span class='no-xx'></span><span class='no-xx'></span><span class='no-xx'></span><span class='no-xx'></span>"
			                	}else if(rows[i].grade==2){
			                		var grade ="<span></span><span></span><span class='no-xx'></span><span class='no-xx'></span><span class='no-xx'></span>"
			                	}else if(rows[i].grade==3){
			                		var grade ="<span></span><span></span><span></span><span class='no-xx'></span><span class='no-xx'></span>"
			                	}else if(rows[i].grade==4){
			                		var grade ="<span></span><span></span><span></span><span></span><span class='no-xx'></span>"
			                	}else if(rows[i].grade==5){
			                		var grade ="<span></span><span></span><span></span><span></span><span></span>"
			                	}
			                	
		                    result += "<div class='plList'><div class='left tu'><div class='pltu'><img src='"+ avatarUrl +"' alt='' /></div>"+ nickName +"</div><div class='right plzi'>"
		                           + "<div class='plxx'>"+grade
		                           + "<div class='timed'>"+ createTime +"</div></div><div class='pltail'>"+ evaluationContent +"</div></div></div>";
			                }
			                 // 如果没有数据
			              }else{
			                     // 锁定
			                     me.lock('down');
			                     // 无数据
			                     me.noData();
			              }
			                 // 为了测试，延迟1秒加载
			              setTimeout(function(){
			                     // 插入数据到页面，放到最后面
			                     $('#evaluatelistmore').append(result);
			                     // 每次数据插入，必须重置
			                     me.resetload();
			              },1000);
		              
		            }else{
		            	alert(data.msg);
		            }
		          },
			        error: function(xhr, type){
			             $.toast(data.msg);
			             // 即使加载出错，也得重置
			             me.resetload();
			        }
		        });
			    }
		    });
		}
	</script>
	
  </body>
</html>